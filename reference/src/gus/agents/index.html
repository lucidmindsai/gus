<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>Agents - gus</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../../../css/theme.css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Agents";
    var mkdocs_page_input_path = "reference/src/gus/agents.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> gus</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Reference</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Src</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../../">Index</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Gus</a>
    <ul class="current">
                <li class="toctree-l3 current"><a class="reference internal current" href="./">Agents</a>
    <ul class="current">
    <li class="toctree-l4"><a class="reference internal" href="#classes">Classes</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../allometrics/">Allometrics</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../">Index</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/">Models</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../utilities/">Utilities</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../weather/">Weather</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Impacts</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../impacts/carbon/">Carbon</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../impacts/">Index</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../impacts/water/">Water</a>
                </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">gus</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Reference &raquo;</li>
        
      
        
          <li>Src &raquo;</li>
        
      
        
          <li>Gus &raquo;</li>
        
      
    
    <li>Agents</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/lucidmindsai/gus/edit/main/reference/src/gus/agents.md"> Edit on gus</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="module-srcgusagents">Module src.gus.agents</h1>
<p>None</p>
<p>None</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Basic Python packages</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Mesa Packages</span>

<span class="kn">from</span> <span class="nn">mesa</span> <span class="kn">import</span> <span class="n">Agent</span>

<span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A generic Tree agent with basic structural attributes and a growth model.</span>

<span class="sd">    It inherits the generic mesa.Agent class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Def: Carbon storage cap in sequestration calculations. A tree with that amount of CARBON or above this level</span>

    <span class="c1"># has a constant yearly sequestration which is 25kg/year.</span>

    <span class="c1"># Unit: Kg</span>

    <span class="c1"># Ref: iTree, 2020</span>

    <span class="n">carbon_storage_cap</span> <span class="o">=</span> <span class="mi">7500</span>

    <span class="n">sequestration_at_maturity</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="c1"># The coeff is used to estimate carbon storage through biomass.</span>

    <span class="c1"># The stock of carbon is estimated by multiplying tree biomass by 0.5</span>

    <span class="c1"># (Chow and Rolfe 1989).</span>

    <span class="n">carbon_coeff</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="c1"># The coeff is used as the generic decomposition rate of dead portion of a tree.</span>

    <span class="c1"># For more accurate estimates on decompostion revise the methods at Nowak et al. (2002b, 2008)</span>

    <span class="n">decomposition_coeff</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># Fixed rates for crown light exposure to sunlight (CLE).</span>

    <span class="c1"># 0.44: Forest conditions with a closed, or nearly closed canopy,</span>

    <span class="c1"># 0.56: Park conditions</span>

    <span class="c1"># 1.0:  Open-grown conditions, street trees.</span>

    <span class="c1"># Source: iTree</span>

    <span class="n">sun_exposure_rates</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s1">&#39;forest&#39;</span><span class="p">:</span> <span class="mf">0.44</span><span class="p">,</span>

        <span class="s1">&#39;park&#39;</span><span class="p">:</span> <span class="mf">0.56</span><span class="p">,</span>

        <span class="s1">&#39;street&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>

        <span class="s1">&#39;pocket&#39;</span><span class="p">:</span><span class="mf">0.56</span><span class="p">}</span>

    <span class="c1"># Condition multipliers. Used at adjusting growth rates.</span>

    <span class="c1"># Ref: Fleming, 1988, and Nowak 2002b</span>

    <span class="n">condition_multiplier</span> <span class="o">=</span> <span class="p">{</span>

        <span class="s1">&#39;excellent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s1">&#39;good&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s1">&#39;fair&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s1">&#39;poor&#39;</span><span class="p">:</span> <span class="mf">0.76</span><span class="p">,</span>

        <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="mf">0.42</span><span class="p">,</span>

        <span class="s1">&#39;dying&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>

        <span class="s1">&#39;dead&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Ref: Root to shoot ratio (Cairns et al. 1997)</span>

    <span class="n">root_to_shoot_ratio</span> <span class="o">=</span> <span class="mf">0.26</span>

    <span class="c1"># Biomass ratio at crown to trunk: Needs validation</span>

    <span class="n">crown_to_trunk_ratio</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dbh</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span>

                 <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

                 <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;deciduous&quot;</span><span class="p">,</span>

                 <span class="n">fixed_sun_exposure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>

                 <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>

                 <span class="n">dieback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The constructor method.</span>

<span class="sd">        Args:</span>

<span class="sd">            unique_id: (:obj:`int`): a unique agent id</span>

<span class="sd">            model: (Mesa.Model): the underlying Mesa model.</span>

<span class="sd">            dbh: (:obj:`float`): the DBH measure which is diameter in cm of the trunk</span>

<span class="sd">                usually measured at 1.3m from the ground.</span>

<span class="sd">            species: (:obj:`str`): species identifier</span>

<span class="sd">            height: (:obj:`float`): The tree height in meters.</span>

<span class="sd">            kind: (:obj:`str`): identifies the kind of tree can be either &quot;deciduous&quot; or</span>

<span class="sd">                &quot;coniferous&quot; (needles)</span>

<span class="sd">            fixed_sun_exposure: (:obj:`bool`): If sun exposure is fixed or to be checked at each</span>

<span class="sd">                iteration.</span>

<span class="sd">            condition: (:obj:`str`): The health condition of the tree.</span>

<span class="sd">            dieback: (:obj:`float`): The percent (0.1 for 10%, etc) of the tree that is dead.</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initializing parent Class.</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="c1"># Initializing variables for a Tree.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">fuzzymatching</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span> <span class="o">=</span> <span class="n">dbh</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_sun_exposure</span> <span class="o">=</span> <span class="n">fixed_sun_exposure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">overlap_ratio</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Initialize canonical growth functions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_tree_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">get_eqn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span><span class="s1">&#39;height&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_biomass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">get_eqn_biomass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_crown_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">get_eqn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span><span class="s1">&#39;crown_width&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_crown_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">get_eqn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span><span class="s1">&#39;crown_height&#39;</span><span class="p">)</span>

        <span class="c1"># Record initial allometries</span>

        <span class="k">if</span> <span class="n">height</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span> <span class="o">=</span> <span class="n">height</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crown_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_crown_width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crown_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_crown_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="c1"># dieback related initializations:</span>

        <span class="c1"># Note: this needs to be handled at the initialization module</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;excellent&#39;</span>

        <span class="k">if</span> <span class="n">dieback</span> <span class="ow">and</span> <span class="n">condition</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">dieback</span>

        <span class="k">elif</span> <span class="n">dieback</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="n">dieback</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">dieback</span>

        <span class="k">elif</span> <span class="n">condition</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_dieback</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dieback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">diameter_growth</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">get_diameter_growth</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

        <span class="c1"># Slow, moderate and fast growing species respectively.</span>

        <span class="c1"># c(0.23, 0.33, 0.43) in inch/yr Source: https://database.itreetools.org/#/splash</span>

        <span class="c1"># Converted into cm.</span>

        <span class="c1">#Default crown light exposure based on site types.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cle</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">sun_exposure_rates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">site_type</span><span class="p">]</span>

        <span class="c1"># Crown light exposure to sunlight (CLE).</span>

        <span class="c1"># CLE &lt;- c(0.44, 0.56, 1)</span>

        <span class="c1"># (1) Forest conditions with a closed, or nearly closed canopy,</span>

        <span class="c1"># (2) Park conditions</span>

        <span class="c1"># (3) Open-grown conditions.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">average_height_at_maturity</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">get_height_at_maturity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>

        <span class="c1"># Avg height at maturity for the given species.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_biomass</span><span class="p">()</span>  <span class="c1"># In Kg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_coeff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span>  <span class="c1"># In Kg</span>

        <span class="c1"># Amount of carbon release due to dead portion.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decomposition</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># In Kg</span>

        <span class="c1"># Annual carbon sequestration in Kg.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mulched</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_root</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_trunk</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">immediate_release</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">death_acc</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">maintenance_scope</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">expected_care</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">maintenance_scope</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">expected_care</span> <span class="o">=</span> <span class="mf">0.3</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">expected_care</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;State transitions of a given Tree agent.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Note:</span>

<span class="sd">            None</span>

<span class="sd">        Todo:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Once the replaced tree agents are removed from the model, this line will be idle and s</span>

        <span class="c1"># should be removed too.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;replaced&#39;</span><span class="p">:</span>

            <span class="k">return</span>

        <span class="c1"># The tree is dead and its carbon release schedule is accounted.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_acc</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_release_track</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_care</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;dead&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">compute_decomposition</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="c1"># check frost free days for the past year.</span>

        <span class="n">frost_free_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">WeatherAPI</span><span class="o">.</span><span class="n">check_frost_free_days</span><span class="p">()</span>

        <span class="c1">#print(&#39;Tree: {} checks ffdays = {} ...&#39;.format(self.unique_id, frost_free_days))</span>

        <span class="c1"># compute the light exposure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_light_exposure</span><span class="p">()</span>

        <span class="c1"># check state of the health of the tree</span>

        <span class="c1">#print(&#39;Tree: {} checks dieback ...&#39;.format(self.unique_id))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_dieback</span><span class="p">()</span>

        <span class="c1"># compute the growth</span>

        <span class="c1">#print(&#39;Tree: {} grows ...&#39;.format(self.unique_id))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grow</span><span class="p">(</span><span class="n">frost_free_days</span><span class="p">)</span>

        <span class="c1"># compute the total biomass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_biomass</span><span class="p">()</span>

        <span class="c1">#print(&#39;Tree: {} biomass ...&#39;.format(self.unique_id))</span>

        <span class="c1"># compute the amount of new carbon sequestration</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_sequestration</span><span class="p">()</span>

        <span class="c1">#print(&#39;Tree: {} sequestration ...&#39;.format(self.unique_id))</span>

        <span class="c1"># compute the amount of carbon release due to decomposition</span>

        <span class="c1">#print(&#39;Tree: {} decomposition ...&#39;.format(self.unique_id))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_decomposition</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frost_free_days</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The method updates DBH of the tree. Currently it is an annual growth in cm.</span>

<span class="sd">        Args:</span>

<span class="sd">            frost_free_days: (:obj:`int`): the number of observed frost free days</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Note:</span>

<span class="sd">            Current version uses the growth model, where</span>

<span class="sd">            the number of frost free days and species specific diameter growth factor is</span>

<span class="sd">            sufficient for the growth mode. Site specific and species specific diameter growth needs</span>

<span class="sd">            to be considered.</span>

<span class="sd">            As a tree approaches “maximum” height, growth rate decreases. Thus,the species growth rates</span>

<span class="sd">            are adjusted based on the ratio between the current height of the tree and the average height</span>

<span class="sd">            at maturity for the species. The estimated tree height at maturity is derived from the literature.</span>

<span class="sd">            When a tree’s height is more than 80 percent of its average height at maturity,</span>

<span class="sd">            the annual diameter growth is proportionally reduced from full growth at 80 percent of maximum height</span>

<span class="sd">            to 2.22 percent of full growth at 125 percent of height at maturity.</span>

<span class="sd">        Todo:</span>

<span class="sd">            The constants in the formulas below needs to be parameterized.</span>

<span class="sd">            References for the current constants:</span>

<span class="sd">            David J. Nowak, 2020. Understanding i-Tree: Summary of Programs and Methods</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># This equation need to be corrected. Check i-tree paper.</span>

        <span class="n">height_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_height_at_maturity</span>

        <span class="k">if</span> <span class="n">height_ratio</span> <span class="o">&gt;=</span> <span class="mf">1.25</span><span class="p">:</span>

            <span class="n">delta_dbh</span> <span class="o">=</span> <span class="mf">0.0222</span>

        <span class="k">elif</span> <span class="n">height_ratio</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>

            <span class="c1"># delta_dbh = 0.0222 + ((1 - 0.0222) / (1.25 - 0.8)) * (1.25 - height_ratio)</span>

            <span class="n">delta_dbh</span> <span class="o">=</span> <span class="mf">0.0222</span> <span class="o">+</span> <span class="mf">2.1729</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.25</span> <span class="o">-</span> <span class="n">height_ratio</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">delta_dbh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diameter_growth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cle</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span><span class="p">)</span>

        <span class="c1"># Adjust the growth rate according to health condition.</span>

        <span class="n">delta_dbh</span> <span class="o">*=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">condition_multiplier</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span> <span class="o">+=</span> <span class="n">delta_dbh</span> <span class="o">*</span> <span class="p">(</span><span class="n">frost_free_days</span> <span class="o">/</span> <span class="mi">153</span><span class="p">)</span>

        <span class="c1"># Update the tree height based on the updated dbh.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_tree_height</span><span class="p">(</span><span class="kp">generic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Update the change at canopy.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_crown_width</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_crown_height</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">estimate_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Computes the height of tree based on the species and current dbh.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Todo:</span>

<span class="sd">            In case of absence of a height function a generic function is used.</span>

<span class="sd">            Current generic function is based on family of height functions yet still</span>

<span class="sd">            arbitrary. It needs to be updated by the higher level phenotypes (needle, leaf, etc.)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span>

    <span class="k">def</span> <span class="nf">update_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kp">generic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Computes the height of tree based on the species and current dbh.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="kp">generic</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fleming_height</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fleming_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Updates the tree height based on the model by Fleming (1988)</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span> <span class="o">+=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">condition_multiplier</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.15</span>

    <span class="k">def</span> <span class="nf">update_crown_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Computes the vertical length of the tree crown based on</span>

<span class="sd">        the species and its current dbh.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`): Current crown width in meters</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crown_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_crown_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crown_height</span>

    <span class="k">def</span> <span class="nf">update_crown_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Computes the horizontal length of the tree crown based on</span>

<span class="sd">        the species and its current dbh.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`): Current crown width in meters</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crown_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_crown_width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crown_width</span>

    <span class="k">def</span> <span class="nf">compute_light_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The method computes light exposure of a tree on a dynamic manner.</span>

<span class="sd">        The tree checks the state of its neighbouring trees and determines its current CLE.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Note:</span>

<span class="sd">            Current version checks out other trees within the same grid.</span>

<span class="sd">            It checks height and width of each neighboring tree.</span>

<span class="sd">            Canopy overlap ratio is used as proxy to determine available CLE. The model assumes that</span>

<span class="sd">            a taller neighbourung tree reduces sun light exposure.</span>

<span class="sd">        Todo:</span>

<span class="sd">            * The assumption needs to be revisited and validated.</span>

<span class="sd">            * The model needs to be revised in case the same location is shared by other species.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_sun_exposure</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1">#cellmates = self.model.grid.get_cell_list_contents([self.pos])</span>

        <span class="n">posns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_neighborhood</span><span class="p">(</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>

            <span class="n">moore</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

            <span class="n">include_center</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">neighboors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_cell_list_contents</span><span class="p">(</span><span class="n">posns_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">overlap_ratio</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">combined_overlap</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">neighboors</span><span class="p">:</span>

            <span class="n">t_w</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">crown_width</span>

            <span class="n">t_h</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">tree_height</span>

            <span class="c1"># 0.5 multiplier is a mean multiplier to correct square shaped assumption on tree crown shape.</span>

            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crown_width</span> <span class="o">+</span> <span class="n">t_w</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dt_resolution</span><span class="p">)</span>

            <span class="c1"># 0.25 multiplier is to account one of the four sides of the grid cell.</span>

            <span class="n">overlap_ratio</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">overlap</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">crown_width</span><span class="p">))</span>

            <span class="c1"># a taller tree creates more shading</span>

            <span class="n">combined_overlap</span> <span class="o">+=</span> <span class="n">overlap_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_h</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_h</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_height</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">overlap_ratio</span> <span class="o">+=</span> <span class="n">overlap_ratio</span>

        <span class="c1"># Cases needs to be inspected</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">overlap_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap_ratio</span><span class="p">)</span>

        <span class="n">light_loss_multiplier</span> <span class="o">=</span> <span class="mf">0.75</span> <span class="c1"># arbitrary to be fixed with empirical data.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cle</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">light_loss_multiplier</span> <span class="o">*</span> <span class="n">combined_overlap</span><span class="p">)</span>

        <span class="c1"># try:</span>

        <span class="c1">#     total_dbh = sum([t.dbh for t in cellmates])</span>

        <span class="c1">#     cle = self.dbh / total_dbh</span>

        <span class="c1"># except ZeroDivisionError as err:</span>

        <span class="c1">#     print(self.unique_id, err)</span>

        <span class="c1">#     cle = 0.56</span>

        <span class="c1"># self.cle = cle</span>

    <span class="k">def</span> <span class="nf">compute_contagion_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;A very simplified version of contagion.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`):  contagion risk a value within the inclusive range [0,0.9]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">posns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_neighborhood</span><span class="p">(</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>

            <span class="n">moore</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

            <span class="n">include_center</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">neighboors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">get_cell_list_contents</span><span class="p">(</span><span class="n">posns_list</span><span class="p">)</span>

        <span class="n">count_neighboors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighboors</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">count_neighboors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

        <span class="n">contagion_risk</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">atree</span> <span class="ow">in</span> <span class="n">neighboors</span><span class="p">:</span>

            <span class="n">contagion_risk</span> <span class="o">+=</span> <span class="n">atree</span><span class="o">.</span><span class="n">dieback</span>

        <span class="k">if</span> <span class="n">count_neighboors</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>

            <span class="n">contagion_risk</span> <span class="o">/=</span> <span class="n">count_neighboors</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">contagion_risk</span> <span class="o">/=</span> <span class="mi">4</span>

        <span class="c1">#TODO: 0.9 is an adjustment parameter that needs calibration.</span>

        <span class="k">return</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">contagion_risk</span>

    <span class="k">def</span> <span class="nf">check_dieback</span><span class="p">(</span>

            <span class="bp">self</span><span class="p">,</span>

            <span class="n">stochastic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>

            <span class="n">risk_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>

            <span class="n">healing_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The dieback calculation for the tree. It is a path dependent.</span>

<span class="sd">        A &#39;random walk&#39; from latest state is considered. The new rate is drawn from</span>

<span class="sd">        a uniform distribution between -1 * healing_rate and risk_rate. A tree with</span>

<span class="sd">        a dieback ratio 1 can not recover.</span>

<span class="sd">        Args:</span>

<span class="sd">            risk_rate: (:obj:`float`): A mean risk rate used to draw a random dieback ratio.</span>

<span class="sd">            healing_rate: (:obj:`float`): A mean healing rate that is used to model recovery rate</span>

<span class="sd">            of a tree from a sickness.</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`): dieback ratio.</span>

<span class="sd">        Todo:</span>

<span class="sd">            Update the data either using measured dieback for species or</span>

<span class="sd">            a site/species specific distribution function.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">register_death</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;dead&#39;</span>

        <span class="c1"># The dieback model below is based on Nowak et al (1986, 2002b:p13)</span>

        <span class="c1"># Mortality rate:</span>

        <span class="c1">#  100% for dead trees</span>

        <span class="c1">#  1.96% for good-excellent and DBH &lt; 3inches</span>

        <span class="c1">#  1.46% for good-excellent and DBH &gt; 3inches</span>

        <span class="c1">#  3.32% for fair condition</span>

        <span class="c1">#  8.86% for poor condition</span>

        <span class="c1">#  13.08% for critical condition</span>

        <span class="c1">#  50% for dying condition</span>

        <span class="n">risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">maintenance_scope</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">dr</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">maintenance_scope</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">dr</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">dr</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;dead&#39;</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;excellent&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span> <span class="o">&lt;</span> <span class="mf">7.62</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&lt;=</span> <span class="mf">0.0196</span> <span class="o">*</span> <span class="n">dr</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;excellent&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span> <span class="o">&gt;=</span> <span class="mf">7.62</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&lt;=</span> <span class="mf">0.0146</span> <span class="o">*</span> <span class="n">dr</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;fair&#39;</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&lt;=</span> <span class="mf">0.0332</span> <span class="o">*</span> <span class="n">dr</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;poor&#39;</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&lt;=</span> <span class="mf">0.0886</span> <span class="o">*</span> <span class="n">dr</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&lt;=</span> <span class="mf">0.1308</span> <span class="o">*</span> <span class="n">dr</span><span class="p">:</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;dying&#39;</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dr</span><span class="p">):</span>

            <span class="n">register_death</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># The dieback model below is path dependent and depends on</span>

            <span class="c1"># (i) the latest condition of the tree,</span>

            <span class="c1"># (ii) the age via DBH and</span>

            <span class="c1"># (iii) the health of neighboring trees.</span>

            <span class="c1"># the new rate is drawn from a</span>

            <span class="c1"># uniform distribution between -1 * healing_rate and risk_rate.</span>

            <span class="k">if</span> <span class="n">stochastic</span><span class="p">:</span>

                <span class="n">contagion_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_contagion_risk</span><span class="p">()</span>

                <span class="c1">#multiplier = Tree.condition_multiplier[self.condition] * np.sqrt(self.dbh)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;excellent&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">-=</span> <span class="mf">0.001</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">+=</span> <span class="mf">0.001</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;good&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">-=</span> <span class="mf">0.005</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">+=</span> <span class="mf">0.005</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">contagion_risk</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="kp">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span> <span class="o">/</span> <span class="n">dr</span>

                    <span class="k">if</span> <span class="n">multiplier</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>

                        <span class="n">heal_range</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">healing_rate</span>

                        <span class="n">die_range</span> <span class="o">=</span> <span class="n">risk_rate</span> <span class="o">/</span> <span class="n">multiplier</span>

                        <span class="c1">#die_range = risk_rate</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="n">heal_range</span><span class="p">,</span> <span class="n">die_range</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dieback</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span>

    <span class="k">def</span> <span class="nf">_get_condition_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dieback</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Determines the condition class based percent crown lost.</span>

<span class="sd">        Args:</span>

<span class="sd">            dieback: (:obj:`float`): percent crown lost</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`str`): condition class.</span>

<span class="sd">        Note:</span>

<span class="sd">             The class brackets are based on Nowak 2002b.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dieback</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;excellent&#39;</span>

        <span class="k">elif</span> <span class="n">dieback</span> <span class="o">&lt;=</span> <span class="mf">0.10</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;good&#39;</span>

        <span class="k">elif</span> <span class="n">dieback</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;fair&#39;</span>

        <span class="k">elif</span> <span class="n">dieback</span> <span class="o">&lt;=</span> <span class="mf">0.50</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;poor&#39;</span>

        <span class="k">elif</span> <span class="n">dieback</span> <span class="o">&lt;=</span> <span class="mf">0.75</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>

        <span class="k">elif</span> <span class="n">dieback</span> <span class="o">&lt;=</span> <span class="mf">0.99</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;dying&#39;</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;dead&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>

        <span class="k">return</span> <span class="n">condition</span>

    <span class="k">def</span> <span class="nf">_estimate_dieback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Draws a crown dieback ratio based on the condition class.</span>

<span class="sd">        Args:</span>

<span class="sd">            dieback: (:obj:`str`): condition class.</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`str`): (:obj:`float`): percent crown lost.</span>

<span class="sd">        Note:</span>

<span class="sd">             This is used when percent crown data is missing but condition of</span>

<span class="sd">             of a tree is given a qualitatively. Condition class brackets are based on Nowak 2002b.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;excellent&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;good&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;fair&#39;</span><span class="p">:</span>

            <span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;poor&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mf">0.26</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;dying&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mf">0.76</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span>

    <span class="k">def</span> <span class="nf">compute_biomass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_height</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;The biomass calculation for the tree, in KG.</span>

<span class="sd">        Args:</span>

<span class="sd">            species: (:obj:`string`): name of the species in &#39;genusName_speciesName&#39; format.</span>

<span class="sd">            Ex: &#39;picea_abies&#39;. Use the iTree naming scheme: https://database.itreetools.org/#/speciesSearch</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`): Biomass in Kg.</span>

<span class="sd">        Todo:</span>

<span class="sd">            Update the generic biomass.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_biomass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">)</span>

        <span class="n">carbon_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span> <span class="o">*</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_coeff</span>

        <span class="k">if</span> <span class="n">carbon_estimate</span> <span class="o">&gt;</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_storage_cap</span><span class="p">:</span>

            <span class="c1">#self.biomass = (1 / Tree.carbon_coeff) * Tree.carbon_storage_cap</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_storage_cap</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span>

    <span class="k">def</span> <span class="nf">_reset_release_track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The resetting state variables that is being observed by data collectors.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mulched</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_root</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_trunk</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">immediate_release</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">compute_decomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The amount of carbon release in KG due to partial diebacks.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Todo:</span>

<span class="sd">            This module on carbon release from alive trees due to partial diebacks or</span>

<span class="sd">            crown loss needs to be revised.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># self.release = self.decomposition_rate * self.dieback * self.carbon_storage</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_release_track</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;dead&#39;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_decomposition_dead</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="c1"># the tree is alive</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_decomposition_alive</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_decomposition_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The amount of carbon release in KG due to partial diebacks.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Todo:</span>

<span class="sd">            This module on carbon release from alive trees due to partial diebacks or</span>

<span class="sd">            crown loss needs to be revised.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">to_decompose</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">crown_to_trunk_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mulched</span> <span class="o">=</span> <span class="n">to_decompose</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># 100% of the removed dead brunches are burned etc.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">immediate_release</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">to_decompose</span>

    <span class="k">def</span> <span class="nf">_compute_decomposition_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The amount of carbon release in KG due to diebacks.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`): Amount of carbon release in KG.</span>

<span class="sd">        Todo:</span>

<span class="sd">            This implementation is based on Nowak et al. (2002b, 2008)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># self.release = self.decomposition_rate *  self.carbon_storage</span>

        <span class="c1"># accounting carbon release process</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">death_acc</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_root</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">root_to_shoot_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span>

        <span class="n">decomposable_above_ground</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_root</span>

        <span class="c1"># the probability of being removed from the site</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>

            <span class="c1"># 70% chance burnt, 30% converted into sustainable products</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">immediate_release</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">decomposable_above_ground</span>

            <span class="k">return</span>

        <span class="c1"># Not removed from the site:</span>

        <span class="c1"># The probability of standing</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">decomposing_trunk</span> <span class="o">=</span> <span class="n">decomposable_above_ground</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mulched</span> <span class="o">=</span> <span class="n">decomposable_above_ground</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">compute_sequestration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;The method estimates annual amount of sequestration in Kg. The model is based on</span>

<span class="sd">        Chow and Rolfe (1989) and used by iTree.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`float`): annual sequestration in carbon.</span>

<span class="sd">        Note:</span>

<span class="sd">            The growth of the tree needs to be adjusted for the health condition of a tree</span>

<span class="sd">            &quot;For trees in fair to excellent condition, growth rates were multiplied by 1 (no adjustment),</span>

<span class="sd">            poor trees’ growth rates were multiplied by 0.76, critical trees by 0.42,</span>

<span class="sd">            and dying trees by 0.15 (dead trees’ growth rates = 0).</span>

<span class="sd">            Adjustment factors were based on percent crown dieback and the assumption that</span>

<span class="sd">            less than 25-percent crown dieback had a limited effect on d.b.h. growth rates.&quot;(Nowak et al, 2002b)</span>

<span class="sd">            The difference in estimates of C storage between year x and year x+1 is the gross amount of</span>

<span class="sd">            C sequestered annually.</span>

<span class="sd">        Todo:</span>

<span class="sd">            - Raise Warning/Error for unexpected behaviors</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dieback</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span>

        <span class="n">carbon_storage_lag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span>

        <span class="n">carbon_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biomass</span> <span class="o">*</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_coeff</span>

        <span class="c1"># min() function prevents carbon storage from over estimation for very</span>

        <span class="c1"># large trees</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">carbon_estimate</span><span class="p">,</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_storage_cap</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">carbon_estimate</span> <span class="o">&gt;=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">carbon_storage_cap</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">sequestration_at_maturity</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span>

        <span class="n">sequestration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span> <span class="o">-</span> <span class="n">carbon_storage_lag</span>

        <span class="c1"># Double check and raise a warning message here.</span>

        <span class="k">if</span> <span class="n">sequestration</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">sequestration</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">sequestration_at_maturity</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">carbon_storage</span> <span class="o">=</span> <span class="n">carbon_storage_lag</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span> <span class="o">=</span> <span class="n">sequestration</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_gross_carbon_sequestration</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot; In case of a maintenance project in place a new young tree or sapling is planted</span>

<span class="sd">        at the location where the tree is dead.</span>

<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (:obj:`int`): new agent id.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;replaced&#39;</span>

        <span class="c1"># Replacing with the site specific minimum sapling.</span>

        <span class="n">dbh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sapling_dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sapling_dbh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">next_id</span><span class="p">()</span>

        <span class="n">new_tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span>

            <span class="nb">id</span><span class="p">,</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>

            <span class="n">dbh</span><span class="p">,</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>

            <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;excellent&#39;</span><span class="p">,</span>

            <span class="n">dieback</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">place_agent</span><span class="p">(</span><span class="n">new_tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="kp">add</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">id</span>
</code></pre></div>

</details>
<h2 id="classes">Classes</h2>
<h3 id="tree">Tree</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span>
    <span class="n">unique_id</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">dbh</span><span class="p">,</span>
    <span class="n">species</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;deciduous&#39;</span><span class="p">,</span>
    <span class="n">fixed_sun_exposure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dieback</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">class</span><span class="w"> </span><span class="n">Tree</span><span class="p">(</span><span class="n">Agent</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">    </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">A generic Tree agent with basic structural attributes and a growth model.</span>

<span class="s2">    It inherits the generic mesa.Agent class.</span>

<span class="s2">    </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Def: Carbon storage cap in sequestration calculations. A tree with that amount of CARBON or above this level</span><span class="w"></span>

<span class="w">    </span><span class="c1"># has a constant yearly sequestration which is 25kg/year.</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Unit: Kg</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Ref: iTree, 2020</span><span class="w"></span>

<span class="w">    </span><span class="n">carbon_storage_cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7500</span><span class="w"></span>

<span class="w">    </span><span class="n">sequestration_at_maturity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="w"></span>

<span class="w">    </span><span class="c1"># The coeff is used to estimate carbon storage through biomass.</span><span class="w"></span>

<span class="w">    </span><span class="c1"># The stock of carbon is estimated by multiplying tree biomass by 0.5</span><span class="w"></span>

<span class="w">    </span><span class="c1"># (Chow and Rolfe 1989).</span><span class="w"></span>

<span class="w">    </span><span class="n">carbon_coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"></span>

<span class="w">    </span><span class="c1"># The coeff is used as the generic decomposition rate of dead portion of a tree.</span><span class="w"></span>

<span class="w">    </span><span class="c1"># For more accurate estimates on decompostion revise the methods at Nowak et al. (2002b, 2008)</span><span class="w"></span>

<span class="w">    </span><span class="n">decomposition_coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Fixed rates for crown light exposure to sunlight (CLE).</span><span class="w"></span>

<span class="w">    </span><span class="c1"># 0.44: Forest conditions with a closed, or nearly closed canopy,</span><span class="w"></span>

<span class="w">    </span><span class="c1"># 0.56: Park conditions</span><span class="w"></span>

<span class="w">    </span><span class="c1"># 1.0:  Open-grown conditions, street trees.</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Source: iTree</span><span class="w"></span>

<span class="w">    </span><span class="n">sun_exposure_rates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;forest&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.44</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;park&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.56</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;street&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;pocket&#39;</span><span class="o">:</span><span class="mf">0.56</span><span class="err">}</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Condition multipliers. Used at adjusting growth rates.</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Ref: Fleming, 1988, and Nowak 2002b</span><span class="w"></span>

<span class="w">    </span><span class="n">condition_multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;excellent&#39;</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;good&#39;</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;fair&#39;</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;poor&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.76</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;critical&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.42</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;dying&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.15</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="s1">&#39;dead&#39;</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="err">}</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Ref: Root to shoot ratio (Cairns et al. 1997)</span><span class="w"></span>

<span class="w">    </span><span class="n">root_to_shoot_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.26</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Biomass ratio at crown to trunk: Needs validation</span><span class="w"></span>

<span class="w">    </span><span class="n">crown_to_trunk_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.05</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">unique_id</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">dbh</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">,</span><span class="w"></span>

<span class="w">                 </span><span class="n">height</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">                 </span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;deciduous&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">                 </span><span class="n">fixed_sun_exposure</span><span class="o">=</span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">                 </span><span class="k">condition</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="w"></span>

<span class="w">                 </span><span class="n">dieback</span><span class="o">=</span><span class="k">None</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The constructor method.</span>

<span class="s2">        Args:</span>

<span class="s2">            unique_id: (:obj:`int`): a unique agent id</span>

<span class="s2">            model: (Mesa.Model): the underlying Mesa model.</span>

<span class="s2">            dbh: (:obj:`float`): the DBH measure which is diameter in cm of the trunk</span>

<span class="s2">                usually measured at 1.3m from the ground.</span>

<span class="s2">            species: (:obj:`str`): species identifier</span>

<span class="s2">            height: (:obj:`float`): The tree height in meters.</span>

<span class="s2">            kind: (:obj:`str`): identifies the kind of tree can be either &quot;</span><span class="n">deciduous</span><span class="s2">&quot; or</span>

<span class="s2">                &quot;</span><span class="n">coniferous</span><span class="s2">&quot; (needles)</span>

<span class="s2">            fixed_sun_exposure: (:obj:`bool`): If sun exposure is fixed or to be checked at each</span>

<span class="s2">                iteration.</span>

<span class="s2">            condition: (:obj:`str`): The health condition of the tree.</span>

<span class="s2">            dieback: (:obj:`float`): The percent (0.1 for 10%, etc) of the tree that is dead.</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Initializing parent Class.</span><span class="w"></span>

<span class="w">        </span><span class="k">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">unique_id</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Initializing variables for a Tree.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kind</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">fuzzymatching</span><span class="p">(</span><span class="n">species</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbh</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">fixed_sun_exposure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixed_sun_exposure</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">overlap_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Initialize canonical growth functions</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">f_tree_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">get_eqn</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">,</span><span class="s1">&#39;height&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">f_biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">get_eqn_biomass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">get_eqn</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">,</span><span class="s1">&#39;crown_width&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">get_eqn</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">,</span><span class="s1">&#39;crown_height&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Record initial allometries</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">height</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_tree_height</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_width</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">crown_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_height</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># dieback related initializations:</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Note: this needs to be handled at the initialization module</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">condition</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">condition</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dieback</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">dieback</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dieback</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="k">condition</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">condition</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_estimate_dieback</span><span class="p">(</span><span class="k">condition</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">diameter_growth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">get_diameter_growth</span><span class="p">(</span><span class="n">species</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Slow, moderate and fast growing species respectively.</span><span class="w"></span>

<span class="w">        </span><span class="c1"># c(0.23, 0.33, 0.43) in inch/yr Source: https://database.itreetools.org/#/splash</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Converted into cm.</span><span class="w"></span>

<span class="w">        </span><span class="c1">#Default crown light exposure based on site types.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">sun_exposure_rates</span><span class="err">[</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">site_type</span><span class="err">]</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Crown light exposure to sunlight (CLE).</span><span class="w"></span>

<span class="w">        </span><span class="c1"># CLE &lt;- c(0.44, 0.56, 1)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># (1) Forest conditions with a closed, or nearly closed canopy,</span><span class="w"></span>

<span class="w">        </span><span class="c1"># (2) Park conditions</span><span class="w"></span>

<span class="w">        </span><span class="c1"># (3) Open-grown conditions.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">average_height_at_maturity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">species</span><span class="p">.</span><span class="n">get_height_at_maturity</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Avg height at maturity for the given species.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">compute_biomass</span><span class="p">()</span><span class="w">  </span><span class="c1"># In Kg</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_coeff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w">  </span><span class="c1"># In Kg</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Amount of carbon release due to dead portion.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">decomposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># In Kg</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Annual carbon sequestration in Kg.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">mulched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_trunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">immediate_release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">death_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">maintenance_scope</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">expected_care</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">maintenance_scope</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">expected_care</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">expected_care</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">step</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">State transitions of a given Tree agent.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Note:</span>

<span class="s2">            None</span>

<span class="s2">        Todo:</span>

<span class="s2">            None</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Once the replaced tree agents are removed from the model, this line will be idle and s</span><span class="w"></span>

<span class="w">        </span><span class="c1"># should be removed too.</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;replaced&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="c1"># The tree is dead and its carbon release schedule is accounted.</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">death_acc</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_reset_release_track</span><span class="p">()</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">expected_care</span><span class="o">:</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="k">replace</span><span class="p">()</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">compute_decomposition</span><span class="p">()</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="c1"># check frost free days for the past year.</span><span class="w"></span>

<span class="w">        </span><span class="n">frost_free_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">WeatherAPI</span><span class="p">.</span><span class="n">check_frost_free_days</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="c1">#print(&#39;Tree: {} checks ffdays = {} ...&#39;.format(self.unique_id, frost_free_days))</span><span class="w"></span>

<span class="w">        </span><span class="c1"># compute the light exposure</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">compute_light_exposure</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="c1"># check state of the health of the tree</span><span class="w"></span>

<span class="w">        </span><span class="c1">#print(&#39;Tree: {} checks dieback ...&#39;.format(self.unique_id))</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">check_dieback</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="c1"># compute the growth</span><span class="w"></span>

<span class="w">        </span><span class="c1">#print(&#39;Tree: {} grows ...&#39;.format(self.unique_id))</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">grow</span><span class="p">(</span><span class="n">frost_free_days</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># compute the total biomass</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">compute_biomass</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="c1">#print(&#39;Tree: {} biomass ...&#39;.format(self.unique_id))</span><span class="w"></span>

<span class="w">        </span><span class="c1"># compute the amount of new carbon sequestration</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">compute_sequestration</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="c1">#print(&#39;Tree: {} sequestration ...&#39;.format(self.unique_id))</span><span class="w"></span>

<span class="w">        </span><span class="c1"># compute the amount of carbon release due to decomposition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#print(&#39;Tree: {} decomposition ...&#39;.format(self.unique_id))</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">compute_decomposition</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">grow</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">frost_free_days</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The method updates DBH of the tree. Currently it is an annual growth in cm.</span>

<span class="s2">        Args:</span>

<span class="s2">            frost_free_days: (:obj:`int`): the number of observed frost free days</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Note:</span>

<span class="s2">            Current version uses the growth model, where</span>

<span class="s2">            the number of frost free days and species specific diameter growth factor is</span>

<span class="s2">            sufficient for the growth mode. Site specific and species specific diameter growth needs</span>

<span class="s2">            to be considered.</span>

<span class="s2">            As a tree approaches “maximum” height, growth rate decreases. Thus,the species growth rates</span>

<span class="s2">            are adjusted based on the ratio between the current height of the tree and the average height</span>

<span class="s2">            at maturity for the species. The estimated tree height at maturity is derived from the literature.</span>

<span class="s2">            When a tree’s height is more than 80 percent of its average height at maturity,</span>

<span class="s2">            the annual diameter growth is proportionally reduced from full growth at 80 percent of maximum height</span>

<span class="s2">            to 2.22 percent of full growth at 125 percent of height at maturity.</span>

<span class="s2">        Todo:</span>

<span class="s2">            The constants in the formulas below needs to be parameterized.</span>

<span class="s2">            References for the current constants:</span>

<span class="s2">            David J. Nowak, 2020. Understanding i-Tree: Summary of Programs and Methods</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># This equation need to be corrected. Check i-tree paper.</span><span class="w"></span>

<span class="w">        </span><span class="n">height_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">average_height_at_maturity</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">height_ratio</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.25</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0222</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">height_ratio</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.8</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1"># delta_dbh = 0.0222 + ((1 - 0.0222) / (1.25 - 0.8)) * (1.25 - height_ratio)</span><span class="w"></span>

<span class="w">            </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0222</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.1729</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.25</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">height_ratio</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">diameter_growth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cle</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Adjust the growth rate according to health condition.</span><span class="w"></span>

<span class="w">        </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">condition_multiplier</span><span class="err">[</span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="err">]</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">frost_free_days</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">153</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Update the tree height based on the updated dbh.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">update_tree_height</span><span class="p">(</span><span class="n">generic</span><span class="o">=</span><span class="no">False</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Update the change at canopy.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">update_crown_width</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">update_crown_height</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">estimate_tree_height</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Computes the height of tree based on the species and current dbh.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Todo:</span>

<span class="s2">            In case of absence of a height function a generic function is used.</span>

<span class="s2">            Current generic function is based on family of height functions yet still</span>

<span class="s2">            arbitrary. It needs to be updated by the higher level phenotypes (needle, leaf, etc.)</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_tree_height</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_tree_height</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">generic</span><span class="o">=</span><span class="no">False</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Computes the height of tree based on the species and current dbh.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">generic</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">fleming_height</span><span class="p">()</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_tree_height</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">fleming_height</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Updates the tree height based on the model by Fleming (1988)</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">condition_multiplier</span><span class="err">[</span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.15</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_crown_height</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Computes the vertical length of the tree crown based on</span>

<span class="s2">        the species and its current dbh.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Current crown width in meters</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">crown_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_height</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">crown_height</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_crown_width</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Computes the horizontal length of the tree crown based on</span>

<span class="s2">        the species and its current dbh.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Current crown width in meters</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_width</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_light_exposure</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The method computes light exposure of a tree on a dynamic manner.</span>

<span class="s2">        The tree checks the state of its neighbouring trees and determines its current CLE.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Note:</span>

<span class="s2">            Current version checks out other trees within the same grid.</span>

<span class="s2">            It checks height and width of each neighboring tree.</span>

<span class="s2">            Canopy overlap ratio is used as proxy to determine available CLE. The model assumes that</span>

<span class="s2">            a taller neighbourung tree reduces sun light exposure.</span>

<span class="s2">        Todo:</span>

<span class="s2">            * The assumption needs to be revisited and validated.</span>

<span class="s2">            * The model needs to be revised in case the same location is shared by other species.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">fixed_sun_exposure</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="c1">#cellmates = self.model.grid.get_cell_list_contents([self.pos])</span><span class="w"></span>

<span class="w">        </span><span class="n">posns_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">get_neighborhood</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">moore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">include_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">neighboors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">get_cell_list_contents</span><span class="p">(</span><span class="n">posns_list</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">overlap_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">combined_overlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">neighboors</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">t_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">crown_width</span><span class="w"></span>

<span class="w">            </span><span class="n">t_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tree_height</span><span class="w"></span>

<span class="w">            </span><span class="c1"># 0.5 multiplier is a mean multiplier to correct square shaped assumption on tree crown shape.</span><span class="w"></span>

<span class="w">            </span><span class="n">overlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t_w</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">dt_resolution</span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="c1"># 0.25 multiplier is to account one of the four sides of the grid cell.</span><span class="w"></span>

<span class="w">            </span><span class="n">overlap_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">overlap</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="p">))</span><span class="w"></span>

<span class="w">            </span><span class="c1"># a taller tree creates more shading</span><span class="w"></span>

<span class="w">            </span><span class="n">combined_overlap</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">overlap_ratio</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">t_h</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">t_h</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="p">))</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">overlap_ratio</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">overlap_ratio</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Cases needs to be inspected</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">overlap_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">overlap_ratio</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">light_loss_multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="w"> </span><span class="c1"># arbitrary to be fixed with empirical data.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">light_loss_multiplier</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">combined_overlap</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># try:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#     total_dbh = sum([t.dbh for t in cellmates])</span><span class="w"></span>

<span class="w">        </span><span class="c1">#     cle = self.dbh / total_dbh</span><span class="w"></span>

<span class="w">        </span><span class="c1"># except ZeroDivisionError as err:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#     print(self.unique_id, err)</span><span class="w"></span>

<span class="w">        </span><span class="c1">#     cle = 0.56</span><span class="w"></span>

<span class="w">        </span><span class="c1"># self.cle = cle</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_contagion_risk</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">A very simplified version of contagion.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`):  contagion risk a value within the inclusive range [0,0.9]</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">posns_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">get_neighborhood</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">moore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">include_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">neighboors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">get_cell_list_contents</span><span class="p">(</span><span class="n">posns_list</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">count_neighboors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">neighboors</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">count_neighboors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">atree</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">neighboors</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">atree</span><span class="p">.</span><span class="n">dieback</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">count_neighboors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">count_neighboors</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>

<span class="w">        </span><span class="c1">#TODO: 0.9 is an adjustment parameter that needs calibration.</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">0.9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">contagion_risk</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">check_dieback</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">stochastic</span><span class="o">=</span><span class="no">True</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">risk_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">healing_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The dieback calculation for the tree. It is a path dependent.</span>

<span class="s2">        A &#39;random walk&#39; from latest state is considered. The new rate is drawn from</span>

<span class="s2">        a uniform distribution between -1 * healing_rate and risk_rate. A tree with</span>

<span class="s2">        a dieback ratio 1 can not recover.</span>

<span class="s2">        Args:</span>

<span class="s2">            risk_rate: (:obj:`float`): A mean risk rate used to draw a random dieback ratio.</span>

<span class="s2">            healing_rate: (:obj:`float`): A mean healing rate that is used to model recovery rate</span>

<span class="s2">            of a tree from a sickness.</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): dieback ratio.</span>

<span class="s2">        Todo:</span>

<span class="s2">            Update the data either using measured dieback for species or</span>

<span class="s2">            a site/species specific distribution function.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">def</span><span class="w"> </span><span class="n">register_death</span><span class="p">()</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># The dieback model below is based on Nowak et al (1986, 2002b:p13)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Mortality rate:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  100% for dead trees</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  1.96% for good-excellent and DBH &lt; 3inches</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  1.46% for good-excellent and DBH &gt; 3inches</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  3.32% for fair condition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  8.86% for poor condition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  13.08% for critical condition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  50% for dying condition</span><span class="w"></span>

<span class="w">        </span><span class="n">risk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">maintenance_scope</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">maintenance_scope</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">7.62</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0196</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">7.62</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0146</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fair&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0332</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;poor&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0886</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.1308</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dying&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1"># The dieback model below is path dependent and depends on</span><span class="w"></span>

<span class="w">            </span><span class="c1"># (i) the latest condition of the tree,</span><span class="w"></span>

<span class="w">            </span><span class="c1"># (ii) the age via DBH and</span><span class="w"></span>

<span class="w">            </span><span class="c1"># (iii) the health of neighboring trees.</span><span class="w"></span>

<span class="w">            </span><span class="c1"># the new rate is drawn from a</span><span class="w"></span>

<span class="w">            </span><span class="c1"># uniform distribution between -1 * healing_rate and risk_rate.</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">stochastic</span><span class="o">:</span><span class="w"></span>

<span class="w">                </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">compute_contagion_risk</span><span class="p">()</span><span class="w"></span>

<span class="w">                </span><span class="c1">#multiplier = Tree.condition_multiplier[self.condition] * np.sqrt(self.dbh)</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.001</span><span class="w"></span>

<span class="w">                    </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0.001</span><span class="w"></span>

<span class="w">                </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;good&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.005</span><span class="w"></span>

<span class="w">                    </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0.005</span><span class="w"></span>

<span class="w">                </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">                    </span><span class="n">multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">contagion_risk</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dr</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.01</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">heal_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">healing_rate</span><span class="w"></span>

<span class="w">                        </span><span class="n">die_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">risk_rate</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">multiplier</span><span class="w"></span>

<span class="w">                        </span><span class="c1">#die_range = risk_rate</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">heal_range</span><span class="p">,</span><span class="w"> </span><span class="n">die_range</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_get_condition_class</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">dieback</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Determines the condition class based percent crown lost.</span>

<span class="s2">        Args:</span>

<span class="s2">            dieback: (:obj:`float`): percent crown lost</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`str`): condition class.</span>

<span class="s2">        Note:</span>

<span class="s2">             The class brackets are based on Nowak 2002b.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.01</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.10</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;good&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.25</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fair&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.50</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;poor&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.75</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.99</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;dying&#39;</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">condition</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">condition</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_estimate_dieback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">condition</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Draws a crown dieback ratio based on the condition class.</span>

<span class="s2">        Args:</span>

<span class="s2">            dieback: (:obj:`str`): condition class.</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`str`): (:obj:`float`): percent crown lost.</span>

<span class="s2">        Note:</span>

<span class="s2">             This is used when percent crown data is missing but condition of</span>

<span class="s2">             of a tree is given a qualitatively. Condition class brackets are based on Nowak 2002b.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;good&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.11</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fair&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.11</span><span class="p">,</span><span class="w"> </span><span class="mf">0.26</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;poor&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.26</span><span class="p">,</span><span class="w"> </span><span class="mf">0.51</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.51</span><span class="p">,</span><span class="w"> </span><span class="mf">0.76</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dying&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.76</span><span class="p">,</span><span class="w"> </span><span class="mf">0.99</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_biomass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">ignore_height</span><span class="o">=</span><span class="no">True</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">float</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The biomass calculation for the tree, in KG.</span>

<span class="s2">        Args:</span>

<span class="s2">            species: (:obj:`string`): name of the species in &#39;genusName_speciesName&#39; format.</span>

<span class="s2">            Ex: &#39;picea_abies&#39;. Use the iTree naming scheme: https://database.itreetools.org/#/speciesSearch</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Biomass in Kg.</span>

<span class="s2">        Todo:</span>

<span class="s2">            Update the generic biomass.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_biomass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_coeff</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1">#self.biomass = (1 / Tree.carbon_coeff) * Tree.carbon_storage_cap</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_reset_release_track</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The resetting state variables that is being observed by data collectors.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">mulched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_trunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">immediate_release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_decomposition</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The amount of carbon release in KG due to partial diebacks.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Todo:</span>

<span class="s2">            This module on carbon release from alive trees due to partial diebacks or</span>

<span class="s2">            crown loss needs to be revised.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># self.release = self.decomposition_rate * self.dieback * self.carbon_storage</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_reset_release_track</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">_compute_decomposition_dead</span><span class="p">()</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="c1"># the tree is alive</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_compute_decomposition_alive</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_compute_decomposition_alive</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The amount of carbon release in KG due to partial diebacks.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Todo:</span>

<span class="s2">            This module on carbon release from alive trees due to partial diebacks or</span>

<span class="s2">            crown loss needs to be revised.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">to_decompose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">crown_to_trunk_ratio</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.9</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">mulched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_decompose</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1"># 100% of the removed dead brunches are burned etc.</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">immediate_release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">to_decompose</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">_compute_decomposition_dead</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The amount of carbon release in KG due to diebacks.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Amount of carbon release in KG.</span>

<span class="s2">        Todo:</span>

<span class="s2">            This implementation is based on Nowak et al. (2002b, 2008)</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># self.release = self.decomposition_rate *  self.carbon_storage</span><span class="w"></span>

<span class="w">        </span><span class="c1"># accounting carbon release process</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">death_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">True</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">root_to_shoot_ratio</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"></span>

<span class="w">        </span><span class="n">decomposable_above_ground</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_root</span><span class="w"></span>

<span class="w">        </span><span class="c1"># the probability of being removed from the site</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1"># 70% chance burnt, 30% converted into sustainable products</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">immediate_release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">decomposable_above_ground</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Not removed from the site:</span><span class="w"></span>

<span class="w">        </span><span class="c1"># The probability of standing</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.4</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">decomposing_trunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decomposable_above_ground</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">mulched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decomposable_above_ground</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_sequestration</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The method estimates annual amount of sequestration in Kg. The model is based on</span>

<span class="s2">        Chow and Rolfe (1989) and used by iTree.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): annual sequestration in carbon.</span>

<span class="s2">        Note:</span>

<span class="s2">            The growth of the tree needs to be adjusted for the health condition of a tree</span>

<span class="s2">            &quot;</span><span class="k">For</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">fair</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">excellent</span><span class="w"> </span><span class="k">condition</span><span class="p">,</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">multiplied</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="n">adjustment</span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="n">poor</span><span class="w"> </span><span class="n">trees’</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">multiplied</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">0.76</span><span class="p">,</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">0.42</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="n">dying</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">0.15</span><span class="w"> </span><span class="p">(</span><span class="n">dead</span><span class="w"> </span><span class="n">trees’</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="w"></span>

<span class="w">            </span><span class="n">Adjustment</span><span class="w"> </span><span class="n">factors</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">percent</span><span class="w"> </span><span class="n">crown</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">assumption</span><span class="w"> </span><span class="n">that</span><span class="w"></span>

<span class="w">            </span><span class="k">less</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">25</span><span class="o">-</span><span class="n">percent</span><span class="w"> </span><span class="n">crown</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">limited</span><span class="w"> </span><span class="n">effect</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="p">.</span><span class="s2">&quot;(Nowak et al, 2002b)</span>

<span class="s2">            The difference in estimates of C storage between year x and year x+1 is the gross amount of</span>

<span class="s2">            C sequestered annually.</span>

<span class="s2">        Todo:</span>

<span class="s2">            - Raise Warning/Error for unexpected behaviors</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"></span>

<span class="w">        </span><span class="n">carbon_storage_lag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"></span>

<span class="w">        </span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_coeff</span><span class="w"></span>

<span class="w">        </span><span class="c1"># min() function prevents carbon storage from over estimation for very</span><span class="w"></span>

<span class="w">        </span><span class="c1"># large trees</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">carbon_estimate</span><span class="p">,</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">sequestration_at_maturity</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"></span>

<span class="w">        </span><span class="n">sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">carbon_storage_lag</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Double check and raise a warning message here.</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">sequestration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">sequestration_at_maturity</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carbon_storage_lag</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequestration</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">replace</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">int</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"> In case of a maintenance project in place a new young tree or sapling is planted</span>

<span class="s2">        at the location where the tree is dead.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`int`): new agent id.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;replaced&#39;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Replacing with the site specific minimum sapling.</span><span class="w"></span>

<span class="w">        </span><span class="n">dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sapling_dbh</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sapling_dbh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">next_id</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">new_tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">id</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">dbh</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="o">=</span><span class="s1">&#39;excellent&#39;</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">dieback</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">place_agent</span><span class="p">(</span><span class="n">new_tree</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="k">schedule</span><span class="p">.</span><span class="k">add</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="w"></span>
</code></pre></div>

</details>
<hr />
<h4 id="ancestors-in-mro">Ancestors (in MRO)</h4>
<ul>
<li>mesa.agent.Agent</li>
</ul>
<h4 id="class-variables">Class variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">carbon_coeff</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">carbon_storage_cap</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">condition_multiplier</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">crown_to_trunk_ratio</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">decomposition_coeff</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">root_to_shoot_ratio</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">sequestration_at_maturity</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">sun_exposure_rates</span>
</code></pre></div>

<h4 id="instance-variables">Instance variables</h4>
<div class="codehilite"><pre><span></span><code><span class="n">random</span>
</code></pre></div>

<h4 id="methods">Methods</h4>
<h4 id="advance">advance</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">advance</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">advance</span><span class="p">(</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="n">pass</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="check_dieback">check_dieback</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">check_dieback</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">stochastic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">risk_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
    <span class="n">healing_rate</span><span class="o">=</span><span class="mf">0.005</span>
<span class="p">)</span>
</code></pre></div>

<p>The dieback calculation for the tree. It is a path dependent.
A 'random walk' from latest state is considered. The new rate is drawn from
a uniform distribution between -1 * healing_rate and risk_rate. A tree with
a dieback ratio 1 can not recover.</p>
<p>Args:
    risk_rate: (:obj:<code>float</code>): A mean risk rate used to draw a random dieback ratio.
    healing_rate: (:obj:<code>float</code>): A mean healing rate that is used to model recovery rate
    of a tree from a sickness.</p>
<p>Returns:
    (:obj:<code>float</code>): dieback ratio.</p>
<p>Todo:
    Update the data either using measured dieback for species or
    a site/species specific distribution function.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">check_dieback</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">stochastic</span><span class="o">=</span><span class="no">True</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">risk_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">healing_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The dieback calculation for the tree. It is a path dependent.</span>

<span class="s2">        A &#39;random walk&#39; from latest state is considered. The new rate is drawn from</span>

<span class="s2">        a uniform distribution between -1 * healing_rate and risk_rate. A tree with</span>

<span class="s2">        a dieback ratio 1 can not recover.</span>

<span class="s2">        Args:</span>

<span class="s2">            risk_rate: (:obj:`float`): A mean risk rate used to draw a random dieback ratio.</span>

<span class="s2">            healing_rate: (:obj:`float`): A mean healing rate that is used to model recovery rate</span>

<span class="s2">            of a tree from a sickness.</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): dieback ratio.</span>

<span class="s2">        Todo:</span>

<span class="s2">            Update the data either using measured dieback for species or</span>

<span class="s2">            a site/species specific distribution function.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">def</span><span class="w"> </span><span class="n">register_death</span><span class="p">()</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># The dieback model below is based on Nowak et al (1986, 2002b:p13)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Mortality rate:</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  100% for dead trees</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  1.96% for good-excellent and DBH &lt; 3inches</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  1.46% for good-excellent and DBH &gt; 3inches</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  3.32% for fair condition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  8.86% for poor condition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  13.08% for critical condition</span><span class="w"></span>

<span class="w">        </span><span class="c1">#  50% for dying condition</span><span class="w"></span>

<span class="w">        </span><span class="n">risk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">maintenance_scope</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">maintenance_scope</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">dr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dead&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">7.62</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0196</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">7.62</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0146</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;fair&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0332</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;poor&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0886</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.1308</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dying&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dr</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">register_death</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1"># The dieback model below is path dependent and depends on</span><span class="w"></span>

<span class="w">            </span><span class="c1"># (i) the latest condition of the tree,</span><span class="w"></span>

<span class="w">            </span><span class="c1"># (ii) the age via DBH and</span><span class="w"></span>

<span class="w">            </span><span class="c1"># (iii) the health of neighboring trees.</span><span class="w"></span>

<span class="w">            </span><span class="c1"># the new rate is drawn from a</span><span class="w"></span>

<span class="w">            </span><span class="c1"># uniform distribution between -1 * healing_rate and risk_rate.</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">stochastic</span><span class="o">:</span><span class="w"></span>

<span class="w">                </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">compute_contagion_risk</span><span class="p">()</span><span class="w"></span>

<span class="w">                </span><span class="c1">#multiplier = Tree.condition_multiplier[self.condition] * np.sqrt(self.dbh)</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;excellent&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.001</span><span class="w"></span>

<span class="w">                    </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0.001</span><span class="w"></span>

<span class="w">                </span><span class="n">elif</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;good&#39;</span><span class="o">:</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.005</span><span class="w"></span>

<span class="w">                    </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0.005</span><span class="w"></span>

<span class="w">                </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">                    </span><span class="n">multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">contagion_risk</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dr</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.01</span><span class="o">:</span><span class="w"></span>

<span class="w">                        </span><span class="n">heal_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">multiplier</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">healing_rate</span><span class="w"></span>

<span class="w">                        </span><span class="n">die_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">risk_rate</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">multiplier</span><span class="w"></span>

<span class="w">                        </span><span class="c1">#die_range = risk_rate</span><span class="w"></span>

<span class="w">                        </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">heal_range</span><span class="p">,</span><span class="w"> </span><span class="n">die_range</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_get_condition_class</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="compute_biomass">compute_biomass</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_biomass</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ignore_height</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span>
</code></pre></div>

<p>The biomass calculation for the tree, in KG.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>species</td>
<td>None</td>
<td>(:obj:<code>string</code>): name of the species in 'genusName_speciesName' format.</td>
<td>None</td>
</tr>
<tr>
<td>Ex</td>
<td>None</td>
<td>'picea_abies'. Use the iTree naming scheme: https://database.itreetools.org/#/speciesSearch</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>(</td>
<td>obj:<code>float</code>): Biomass in Kg.</td>
</tr>
<tr>
<td>Todo:</td>
<td></td>
</tr>
<tr>
<td>Update the generic biomass.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_biomass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">ignore_height</span><span class="o">=</span><span class="no">True</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">float</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The biomass calculation for the tree, in KG.</span>

<span class="s2">        Args:</span>

<span class="s2">            species: (:obj:`string`): name of the species in &#39;genusName_speciesName&#39; format.</span>

<span class="s2">            Ex: &#39;picea_abies&#39;. Use the iTree naming scheme: https://database.itreetools.org/#/speciesSearch</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Biomass in Kg.</span>

<span class="s2">        Todo:</span>

<span class="s2">            Update the generic biomass.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_biomass</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_coeff</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1">#self.biomass = (1 / Tree.carbon_coeff) * Tree.carbon_storage_cap</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="compute_contagion_risk">compute_contagion_risk</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_contagion_risk</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>A very simplified version of contagion.</p>
<p>Args:
    None
Returns:
    (:obj:<code>float</code>):  contagion risk a value within the inclusive range [0,0.9]</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_contagion_risk</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">A very simplified version of contagion.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`):  contagion risk a value within the inclusive range [0,0.9]</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">posns_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">get_neighborhood</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">moore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">include_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">False</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">neighboors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">get_cell_list_contents</span><span class="p">(</span><span class="n">posns_list</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">count_neighboors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">neighboors</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">count_neighboors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">atree</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">neighboors</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">atree</span><span class="p">.</span><span class="n">dieback</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">count_neighboors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">count_neighboors</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">contagion_risk</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>

<span class="w">        </span><span class="c1">#TODO: 0.9 is an adjustment parameter that needs calibration.</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">0.9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">contagion_risk</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="compute_decomposition">compute_decomposition</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_decomposition</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>The amount of carbon release in KG due to partial diebacks.</p>
<p>Args:
    None</p>
<p>Returns:
    None</p>
<p>Todo:
    This module on carbon release from alive trees due to partial diebacks or
    crown loss needs to be revised.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">compute_decomposition</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:<span class="w"></span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;The amount of carbon release in KG due to partial diebacks.</span>

<span class="err">        Args:</span>

<span class="err">            None</span>

<span class="err">        Returns:</span>

<span class="err">            None</span>

<span class="err">        Todo:</span>

<span class="err">            This module on carbon release from alive trees due to partial diebacks or</span>

<span class="err">            crown loss needs to be revised.</span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

<span class="err">        # self.release = self.decomposition_rate * self.dieback * self.carbon_storage</span>

<span class="err">        self._reset_release_track()</span>

<span class="err">        if self.condition == &#39;dead&#39;:</span>

<span class="err">            self._compute_decomposition_dead()</span>

<span class="err">            return</span>

<span class="err">        # the tree is alive</span>

<span class="err">        self._compute_decomposition_alive()</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="compute_light_exposure">compute_light_exposure</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_light_exposure</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>The method computes light exposure of a tree on a dynamic manner.
The tree checks the state of its neighbouring trees and determines its current CLE.</p>
<p>Args:
    None</p>
<p>Returns:
    None</p>
<p>Note:
    Current version checks out other trees within the same grid.
    It checks height and width of each neighboring tree.
    Canopy overlap ratio is used as proxy to determine available CLE. The model assumes that
    a taller neighbourung tree reduces sun light exposure.</p>
<p>Todo:
    * The assumption needs to be revisited and validated.
    * The model needs to be revised in case the same location is shared by other species.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">compute_light_exposure</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:<span class="w"></span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;The method computes light exposure of a tree on a dynamic manner.</span>

<span class="err">        The tree checks the state of its neighbouring trees and determines its current CLE.</span>

<span class="err">        Args:</span>

<span class="err">            None</span>

<span class="err">        Returns:</span>

<span class="err">            None</span>

<span class="err">        Note:</span>

<span class="err">            Current version checks out other trees within the same grid.</span>

<span class="err">            It checks height and width of each neighboring tree.</span>

<span class="err">            Canopy overlap ratio is used as proxy to determine available CLE. The model assumes that</span>

<span class="err">            a taller neighbourung tree reduces sun light exposure.</span>

<span class="err">        Todo:</span>

<span class="err">            * The assumption needs to be revisited and validated.</span>

<span class="err">            * The model needs to be revised in case the same location is shared by other species.</span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

<span class="err">        if self.fixed_sun_exposure: return</span>

<span class="err">        #cellmates = self.model.grid.get_cell_list_contents([self.pos])</span>

<span class="err">        posns_list = self.model.grid.get_neighborhood(</span>

<span class="err">            self.pos,</span>

<span class="err">            moore = False,</span>

<span class="err">            include_center = False,</span>

<span class="err">            radius = 1)</span>

<span class="err">        neighboors = self.model.grid.get_cell_list_contents(posns_list)</span>

<span class="err">        self.overlap_ratio = 0</span>

<span class="err">        combined_overlap = 0</span>

<span class="err">        for t in neighboors:</span>

<span class="err">            t_w = t.crown_width</span>

<span class="err">            t_h = t.tree_height</span>

<span class="err">            # 0.5 multiplier is a mean multiplier to correct square shaped assumption on tree crown shape.</span>

<span class="err">            overlap = max(0, 0.5 * (self.crown_width + t_w) - self.model.dt_resolution)</span>

<span class="err">            # 0.25 multiplier is to account one of the four sides of the grid cell.</span>

<span class="err">            overlap_ratio = 0.25 * min(1, (overlap / self.crown_width))</span>

<span class="err">            # a taller tree creates more shading</span>

<span class="err">            combined_overlap += overlap_ratio * (t_h / (t_h + self.tree_height))</span>

<span class="err">            self.overlap_ratio += overlap_ratio</span>

<span class="err">        # Cases needs to be inspected</span>

<span class="err">        self.overlap_ratio = min(1, self.overlap_ratio)</span>

<span class="err">        light_loss_multiplier = 0.75 # arbitrary to be fixed with empirical data.</span>

<span class="err">        self.cle = max(0, 1 - light_loss_multiplier * combined_overlap)</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="compute_sequestration">compute_sequestration</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_sequestration</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>The method estimates annual amount of sequestration in Kg. The model is based on
Chow and Rolfe (1989) and used by iTree.</p>
<p>Args:
    None</p>
<p>Returns:
    (:obj:<code>float</code>): annual sequestration in carbon.</p>
<p>Note:
    The growth of the tree needs to be adjusted for the health condition of a tree
    "For trees in fair to excellent condition, growth rates were multiplied by 1 (no adjustment),
    poor trees’ growth rates were multiplied by 0.76, critical trees by 0.42,
    and dying trees by 0.15 (dead trees’ growth rates = 0).
    Adjustment factors were based on percent crown dieback and the assumption that
    less than 25-percent crown dieback had a limited effect on d.b.h. growth rates."(Nowak et al, 2002b)
    The difference in estimates of C storage between year x and year x+1 is the gross amount of
    C sequestered annually.</p>
<p>Todo:
    - Raise Warning/Error for unexpected behaviors</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">compute_sequestration</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The method estimates annual amount of sequestration in Kg. The model is based on</span>

<span class="s2">        Chow and Rolfe (1989) and used by iTree.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): annual sequestration in carbon.</span>

<span class="s2">        Note:</span>

<span class="s2">            The growth of the tree needs to be adjusted for the health condition of a tree</span>

<span class="s2">            &quot;</span><span class="k">For</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">fair</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">excellent</span><span class="w"> </span><span class="k">condition</span><span class="p">,</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">multiplied</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="n">adjustment</span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="n">poor</span><span class="w"> </span><span class="n">trees’</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">multiplied</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">0.76</span><span class="p">,</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">0.42</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="n">dying</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">0.15</span><span class="w"> </span><span class="p">(</span><span class="n">dead</span><span class="w"> </span><span class="n">trees’</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="w"></span>

<span class="w">            </span><span class="n">Adjustment</span><span class="w"> </span><span class="n">factors</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">percent</span><span class="w"> </span><span class="n">crown</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">assumption</span><span class="w"> </span><span class="n">that</span><span class="w"></span>

<span class="w">            </span><span class="k">less</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">25</span><span class="o">-</span><span class="n">percent</span><span class="w"> </span><span class="n">crown</span><span class="w"> </span><span class="n">dieback</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">limited</span><span class="w"> </span><span class="n">effect</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="w"> </span><span class="n">growth</span><span class="w"> </span><span class="n">rates</span><span class="p">.</span><span class="s2">&quot;(Nowak et al, 2002b)</span>

<span class="s2">            The difference in estimates of C storage between year x and year x+1 is the gross amount of</span>

<span class="s2">            C sequestered annually.</span>

<span class="s2">        Todo:</span>

<span class="s2">            - Raise Warning/Error for unexpected behaviors</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"></span>

<span class="w">        </span><span class="n">carbon_storage_lag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"></span>

<span class="w">        </span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">biomass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_coeff</span><span class="w"></span>

<span class="w">        </span><span class="c1"># min() function prevents carbon storage from over estimation for very</span><span class="w"></span>

<span class="w">        </span><span class="c1"># large trees</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">carbon_estimate</span><span class="p">,</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">carbon_estimate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">carbon_storage_cap</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">sequestration_at_maturity</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"></span>

<span class="w">        </span><span class="n">sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">carbon_storage_lag</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Double check and raise a warning message here.</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">sequestration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">sequestration_at_maturity</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">carbon_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carbon_storage_lag</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sequestration</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">annual_gross_carbon_sequestration</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="estimate_tree_height">estimate_tree_height</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_tree_height</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Computes the height of tree based on the species and current dbh.</p>
<p>Args:
    None</p>
<p>Returns:
    None
Todo:
    In case of absence of a height function a generic function is used.
    Current generic function is based on family of height functions yet still
    arbitrary. It needs to be updated by the higher level phenotypes (needle, leaf, etc.)</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">estimate_tree_height</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:<span class="w"></span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;Computes the height of tree based on the species and current dbh.</span>

<span class="err">        Args:</span>

<span class="err">            None</span>

<span class="err">        Returns:</span>

<span class="err">            None</span>

<span class="err">        Todo:</span>

<span class="err">            In case of absence of a height function a generic function is used.</span>

<span class="err">            Current generic function is based on family of height functions yet still</span>

<span class="err">            arbitrary. It needs to be updated by the higher level phenotypes (needle, leaf, etc.)</span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

<span class="err">        self.tree_height = self.f_tree_height(self.dbh)</span>

<span class="err">        return self.tree_height</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="fleming_height">fleming_height</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">fleming_height</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Updates the tree height based on the model by Fleming (1988)</p>
<p>Args:
    None
Returns:
    None</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def fleming_height(self):

        &quot;&quot;&quot;Updates the tree height based on the model by Fleming (1988)

        Args:

            None

        Returns:

            None

        &quot;&quot;&quot;

        self.tree_height += Tree.condition_multiplier[self.condition] * 0.15
</code></pre></div>

</details>
<h4 id="grow">grow</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">grow</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">frost_free_days</span>
<span class="p">)</span>
</code></pre></div>

<p>The method updates DBH of the tree. Currently it is an annual growth in cm.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>frost_free_days</td>
<td>None</td>
<td>(:obj:<code>int</code>): the number of observed frost free days</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>None</td>
</tr>
</tbody>
</table>
<p>Note:
    Current version uses the growth model, where
    the number of frost free days and species specific diameter growth factor is
    sufficient for the growth mode. Site specific and species specific diameter growth needs
    to be considered.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">As</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">tree</span><span class="w"> </span><span class="nv">approaches</span><span class="w"> </span>“<span class="nv">maximum</span>”<span class="w"> </span><span class="nv">height</span>,<span class="w"> </span><span class="nv">growth</span><span class="w"> </span><span class="nv">rate</span><span class="w"> </span><span class="nv">decreases</span>.<span class="w"> </span><span class="nv">Thus</span>,<span class="nv">the</span><span class="w"> </span><span class="nv">species</span><span class="w"> </span><span class="nv">growth</span><span class="w"> </span><span class="nv">rates</span><span class="w"></span>
<span class="nv">are</span><span class="w"> </span><span class="nv">adjusted</span><span class="w"> </span><span class="nv">based</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">ratio</span><span class="w"> </span><span class="nv">between</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">tree</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">average</span><span class="w"> </span><span class="nv">height</span><span class="w"></span>
<span class="nv">at</span><span class="w"> </span><span class="nv">maturity</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">species</span>.<span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">estimated</span><span class="w"> </span><span class="nv">tree</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">maturity</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">derived</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">literature</span>.<span class="w"></span>
<span class="nv">When</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">tree</span>’<span class="nv">s</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">more</span><span class="w"> </span><span class="nv">than</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="nv">percent</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">its</span><span class="w"> </span><span class="nv">average</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">maturity</span>,<span class="w"></span>
<span class="nv">the</span><span class="w"> </span><span class="nv">annual</span><span class="w"> </span><span class="nv">diameter</span><span class="w"> </span><span class="nv">growth</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">proportionally</span><span class="w"> </span><span class="nv">reduced</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">full</span><span class="w"> </span><span class="nv">growth</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="nv">percent</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">maximum</span><span class="w"> </span><span class="nv">height</span><span class="w"></span>
<span class="nv">to</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">22</span><span class="w"> </span><span class="nv">percent</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">full</span><span class="w"> </span><span class="nv">growth</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="mi">125</span><span class="w"> </span><span class="nv">percent</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">height</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">maturity</span>.<span class="w"></span>
</code></pre></div>

<p>Todo:
    The constants in the formulas below needs to be parameterized.
    References for the current constants:
    David J. Nowak, 2020. Understanding i-Tree: Summary of Programs and Methods |</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">grow</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">frost_free_days</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">The method updates DBH of the tree. Currently it is an annual growth in cm.</span>

<span class="s2">        Args:</span>

<span class="s2">            frost_free_days: (:obj:`int`): the number of observed frost free days</span>

<span class="s2">        Returns:</span>

<span class="s2">            None</span>

<span class="s2">        Note:</span>

<span class="s2">            Current version uses the growth model, where</span>

<span class="s2">            the number of frost free days and species specific diameter growth factor is</span>

<span class="s2">            sufficient for the growth mode. Site specific and species specific diameter growth needs</span>

<span class="s2">            to be considered.</span>

<span class="s2">            As a tree approaches “maximum” height, growth rate decreases. Thus,the species growth rates</span>

<span class="s2">            are adjusted based on the ratio between the current height of the tree and the average height</span>

<span class="s2">            at maturity for the species. The estimated tree height at maturity is derived from the literature.</span>

<span class="s2">            When a tree’s height is more than 80 percent of its average height at maturity,</span>

<span class="s2">            the annual diameter growth is proportionally reduced from full growth at 80 percent of maximum height</span>

<span class="s2">            to 2.22 percent of full growth at 125 percent of height at maturity.</span>

<span class="s2">        Todo:</span>

<span class="s2">            The constants in the formulas below needs to be parameterized.</span>

<span class="s2">            References for the current constants:</span>

<span class="s2">            David J. Nowak, 2020. Understanding i-Tree: Summary of Programs and Methods</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># This equation need to be corrected. Check i-tree paper.</span><span class="w"></span>

<span class="w">        </span><span class="n">height_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">tree_height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">average_height_at_maturity</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">height_ratio</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.25</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0222</span><span class="w"></span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">height_ratio</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.8</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="c1"># delta_dbh = 0.0222 + ((1 - 0.0222) / (1.25 - 0.8)) * (1.25 - height_ratio)</span><span class="w"></span>

<span class="w">            </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0222</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.1729</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.25</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">height_ratio</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="o">:</span><span class="w"></span>

<span class="w">            </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">diameter_growth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cle</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dieback</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Adjust the growth rate according to health condition.</span><span class="w"></span>

<span class="w">        </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">Tree</span><span class="p">.</span><span class="n">condition_multiplier</span><span class="err">[</span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="err">]</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">delta_dbh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">frost_free_days</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">153</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Update the tree height based on the updated dbh.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">update_tree_height</span><span class="p">(</span><span class="n">generic</span><span class="o">=</span><span class="no">False</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Update the change at canopy.</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">update_crown_width</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">update_crown_height</span><span class="p">()</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="replace">replace</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">replace</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span>
</code></pre></div>

<p>In case of a maintenance project in place a new young tree or sapling is planted
at the location where the tree is dead.</p>
<p>Args:
    None
Returns:
    (:obj:<code>int</code>): new agent id.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">replace</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">int</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2"> In case of a maintenance project in place a new young tree or sapling is planted</span>

<span class="s2">        at the location where the tree is dead.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`int`): new agent id.</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="k">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;replaced&#39;</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Replacing with the site specific minimum sapling.</span><span class="w"></span>

<span class="w">        </span><span class="n">dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sapling_dbh</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sapling_dbh</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">next_id</span><span class="p">()</span><span class="w"></span>

<span class="w">        </span><span class="n">new_tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tree</span><span class="p">(</span><span class="w"></span>

<span class="w">            </span><span class="n">id</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">dbh</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">species</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="k">condition</span><span class="o">=</span><span class="s1">&#39;excellent&#39;</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">dieback</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">grid</span><span class="p">.</span><span class="n">place_agent</span><span class="p">(</span><span class="n">new_tree</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="k">schedule</span><span class="p">.</span><span class="k">add</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="step">step</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>State transitions of a given Tree agent.</p>
<p>Args:
    None</p>
<p>Returns:
    None</p>
<p>Note:
    None</p>
<p>Todo:
    None</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">step</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:<span class="w"></span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;State transitions of a given Tree agent.</span>

<span class="err">        Args:</span>

<span class="err">            None</span>

<span class="err">        Returns:</span>

<span class="err">            None</span>

<span class="err">        Note:</span>

<span class="err">            None</span>

<span class="err">        Todo:</span>

<span class="err">            None</span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

<span class="err">        # Once the replaced tree agents are removed from the model, this line will be idle and s</span>

<span class="err">        # should be removed too.</span>

<span class="err">        if self.condition == &#39;replaced&#39;:</span>

<span class="err">            return</span>

<span class="err">        # The tree is dead and its carbon release schedule is accounted.</span>

<span class="err">        if self.death_acc:</span>

<span class="err">            self._reset_release_track()</span>

<span class="err">            if np.random.uniform(0, 1) &lt; self.expected_care:</span>

<span class="err">                self.replace()</span>

<span class="err">            return</span>

<span class="err">        if self.condition == &#39;dead&#39;:</span>

<span class="err">            self.compute_decomposition()</span>

<span class="err">            return</span>

<span class="err">        # check frost free days for the past year.</span>

<span class="err">        frost_free_days = self.model.WeatherAPI.check_frost_free_days()</span>

<span class="err">        #print(&#39;Tree: {} checks ffdays = {} ...&#39;.format(self.unique_id, frost_free_days))</span>

<span class="err">        # compute the light exposure</span>

<span class="err">        self.compute_light_exposure()</span>

<span class="err">        # check state of the health of the tree</span>

<span class="err">        #print(&#39;Tree: {} checks dieback ...&#39;.format(self.unique_id))</span>

<span class="err">        self.check_dieback()</span>

<span class="err">        # compute the growth</span>

<span class="err">        #print(&#39;Tree: {} grows ...&#39;.format(self.unique_id))</span>

<span class="err">        self.grow(frost_free_days)</span>

<span class="err">        # compute the total biomass</span>

<span class="err">        self.compute_biomass()</span>

<span class="err">        #print(&#39;Tree: {} biomass ...&#39;.format(self.unique_id))</span>

<span class="err">        # compute the amount of new carbon sequestration</span>

<span class="err">        self.compute_sequestration()</span>

<span class="err">        #print(&#39;Tree: {} sequestration ...&#39;.format(self.unique_id))</span>

<span class="err">        # compute the amount of carbon release due to decomposition</span>

<span class="err">        #print(&#39;Tree: {} decomposition ...&#39;.format(self.unique_id))</span>

<span class="err">        self.compute_decomposition()</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="update_crown_height">update_crown_height</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_crown_height</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Computes the vertical length of the tree crown based on 
the species and its current dbh.</p>
<p>Args:
    None
Returns:
    (:obj:<code>float</code>): Current crown width in meters</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_crown_height</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Computes the vertical length of the tree crown based on</span>

<span class="s2">        the species and its current dbh.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Current crown width in meters</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">crown_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_height</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">crown_height</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="update_crown_width">update_crown_width</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_crown_width</span><span class="p">(</span>
    <span class="bp">self</span>
<span class="p">)</span>
</code></pre></div>

<p>Computes the horizontal length of the tree crown based on 
the species and its current dbh.</p>
<p>Args:
    None
Returns:
    (:obj:<code>float</code>): Current crown width in meters</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">update_crown_width</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span><span class="w"></span>

<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Computes the horizontal length of the tree crown based on</span>

<span class="s2">        the species and its current dbh.</span>

<span class="s2">        Args:</span>

<span class="s2">            None</span>

<span class="s2">        Returns:</span>

<span class="s2">            (:obj:`float`): Current crown width in meters</span>

<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span><span class="w"></span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">f_crown_width</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dbh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">crown_width</span><span class="w"></span>
</code></pre></div>

</details>
<h4 id="update_tree_height">update_tree_height</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_tree_height</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">generic</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</code></pre></div>

<p>Computes the height of tree based on the species and current dbh.</p>
<p>Args:
    None
Returns:
    None</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">update_tree_height</span><span class="ss">(</span><span class="nv">self</span>,<span class="w"> </span><span class="nv">generic</span><span class="o">=</span><span class="nv">False</span><span class="ss">)</span>:<span class="w"></span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;Computes the height of tree based on the species and current dbh.</span>

<span class="err">        Args:</span>

<span class="err">            None</span>

<span class="err">        Returns:</span>

<span class="err">            None</span>

<span class="w">        </span><span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

<span class="err">        if generic:</span>

<span class="err">            self.fleming_height()</span>

<span class="err">            return</span>

<span class="err">        self.tree_height = self.f_tree_height(self.dbh)</span><span class="w"></span>
</code></pre></div>

</details>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../allometrics/" class="btn btn-neutral float-right" title="Allometrics">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../" class="btn btn-neutral" title="Index"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../allometrics/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme_extra.js" defer></script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="../../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
